{"ast":null,"code":"import { createElementVNode as _createElementVNode, renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString, createCommentVNode as _createCommentVNode } from \"vue\";\nconst _hoisted_1 = {\n  class: \"payment-container\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"subscription-plans\"\n};\nconst _hoisted_3 = {\n  class: \"plans\"\n};\nconst _hoisted_4 = [\"onClick\"];\nconst _hoisted_5 = {\n  class: \"price\"\n};\nconst _hoisted_6 = {\n  class: \"duration\"\n};\nconst _hoisted_7 = {\n  key: 1,\n  class: \"payment-summary\"\n};\nconst _hoisted_8 = {\n  key: 2,\n  class: \"status-modal\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [!$setup.showPaymentForm ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, [_cache[2] || (_cache[2] = _createElementVNode(\"h2\", null, \"Choose Your Plan\", -1)), _createElementVNode(\"div\", _hoisted_3, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.plans, plan => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      class: \"plan\",\n      key: plan.id,\n      onClick: $event => $setup.selectPlan(plan)\n    }, [_createElementVNode(\"h3\", null, _toDisplayString(plan.name), 1), _createElementVNode(\"p\", _hoisted_5, \"₹\" + _toDisplayString(plan.price), 1), _createElementVNode(\"p\", _hoisted_6, _toDisplayString(plan.duration) + \" days\", 1), _cache[1] || (_cache[1] = _createElementVNode(\"button\", {\n      class: \"select-btn\"\n    }, \"Select\", -1))], 8, _hoisted_4);\n  }), 128))])])) : _createCommentVNode(\"\", true), $setup.selectedPlan ? (_openBlock(), _createElementBlock(\"div\", _hoisted_7, [_cache[3] || (_cache[3] = _createElementVNode(\"h3\", null, \"Payment Summary\", -1)), _createElementVNode(\"p\", null, \"Plan: \" + _toDisplayString($setup.selectedPlan.name), 1), _createElementVNode(\"p\", null, \"Amount: ₹\" + _toDisplayString($setup.selectedPlan.price), 1), _createElementVNode(\"button\", {\n    onClick: _cache[0] || (_cache[0] = (...args) => $setup.initiatePayment && $setup.initiatePayment(...args)),\n    class: \"pay-btn\"\n  }, \"Pay Now\")])) : _createCommentVNode(\"\", true), $setup.showStatusModal ? (_openBlock(), _createElementBlock(\"div\", _hoisted_8, _cache[4] || (_cache[4] = [_createElementVNode(\"div\", {\n    class: \"modal-content\"\n  }, [_createElementVNode(\"h3\", null, \"Checking Payment Status...\"), _createElementVNode(\"p\", null, \"Please wait while we verify your payment.\"), _createElementVNode(\"div\", {\n    class: \"loader\"\n  })], -1)]))) : _createCommentVNode(\"\", true)]);\n}","map":{"version":3,"names":["class","_createElementBlock","_hoisted_1","$setup","showPaymentForm","_hoisted_2","_createElementVNode","_hoisted_3","_Fragment","_renderList","plans","plan","key","id","onClick","$event","selectPlan","_toDisplayString","name","_hoisted_5","price","_hoisted_6","duration","selectedPlan","_hoisted_7","_cache","args","initiatePayment","showStatusModal","_hoisted_8"],"sources":["F:\\ott_tv\\ott\\ott_frontend\\src\\components\\Payment.vue"],"sourcesContent":["<template>\n  <div class=\"payment-container\">\n    <div v-if=\"!showPaymentForm\" class=\"subscription-plans\">\n      <h2>Choose Your Plan</h2>\n      <div class=\"plans\">\n        <div class=\"plan\" v-for=\"plan in plans\" :key=\"plan.id\" @click=\"selectPlan(plan)\">\n          <h3>{{ plan.name }}</h3>\n          <p class=\"price\">₹{{ plan.price }}</p>\n          <p class=\"duration\">{{ plan.duration }} days</p>\n          <button class=\"select-btn\">Select</button>\n        </div>\n      </div>\n    </div>\n\n    <div v-if=\"selectedPlan\" class=\"payment-summary\">\n      <h3>Payment Summary</h3>\n      <p>Plan: {{ selectedPlan.name }}</p>\n      <p>Amount: ₹{{ selectedPlan.price }}</p>\n      <button @click=\"initiatePayment\" class=\"pay-btn\">Pay Now</button>\n    </div>\n\n    <!-- Payment Status Modal -->\n    <div v-if=\"showStatusModal\" class=\"status-modal\">\n      <div class=\"modal-content\">\n        <h3>Checking Payment Status...</h3>\n        <p>Please wait while we verify your payment.</p>\n        <div class=\"loader\"></div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport axios from 'axios';\nimport { useStore } from 'vuex';\nimport { computed, onMounted, onUnmounted, ref } from 'vue';\nimport { useRouter, useRoute } from 'vue-router';\n\nexport default {\n  name: 'PaymentPage',\n  setup() {\n    const store = useStore();\n    const router = useRouter();\n    const route = useRoute();\n\n    const plans = ref([\n      { id: 1, name: 'Basic Plan', price: 199, duration: 30 },\n      { id: 2, name: 'Standard Plan', price: 499, duration: 90 },\n      { id: 3, name: 'Premium Plan', price: 999, duration: 365 }\n    ]);\n\n    const selectedPlan = ref(null);\n    const showPaymentForm = ref(false);\n    const showStatusModal = ref(false);\n    const statusCheckInterval = ref(null);\n\n    // Computed properties\n    const user = computed(() => store.state.user);\n    const isAuthenticated = computed(() => store.state.isAuthenticated);\n\n    onMounted(() => {\n      console.log('Payment Component Mounted');\n      \n      if (!isAuthenticated.value || !user.value) {\n        router.push({\n          path: '/login',\n          query: { redirect: route.fullPath }\n        });\n        return;\n      }\n\n      // Check for pending payments\n      checkPendingPayments();\n\n      // Check for plan in route query\n      const planType = route.query.plan;\n      if (planType) {\n        const plan = plans.value.find(p => \n          p.name.toLowerCase().replace(' ', '_') === planType\n        );\n        if (plan) {\n          selectPlan(plan);\n        }\n      }\n    });\n\n    const checkPendingPayments = () => {\n      const pendingPayment = localStorage.getItem('pending_payment');\n      if (pendingPayment) {\n        const payment = JSON.parse(pendingPayment);\n        const timeElapsed = new Date().getTime() - payment.timestamp;\n        \n        // Check if payment was initiated in last 10 minutes\n        if (timeElapsed < 600000) {\n          showStatusModal.value = true;\n          startPaymentStatusCheck(payment.order_id);\n        } else {\n          localStorage.removeItem('pending_payment');\n        }\n      }\n    };\n\n    const selectPlan = (plan) => {\n      console.log('Selected Plan:', plan);\n      selectedPlan.value = plan;\n      showPaymentForm.value = true;\n    };\n\n    const initiatePayment = async () => {\n      try {\n        console.log('Initiating payment for plan:', selectedPlan.value);\n        \n        const orderResponse = await axios.post('/api/payment/create-order/', {\n          amount: selectedPlan.value.price,\n          plan_id: selectedPlan.value.id,\n          phone: user.value?.phone\n        });\n\n        console.log('Order created:', orderResponse.data);\n\n        // Save order details for recovery\n        localStorage.setItem('pending_payment', JSON.stringify({\n          order_id: orderResponse.data.order_id,\n          plan_id: selectedPlan.value.id,\n          amount: selectedPlan.value.price,\n          timestamp: new Date().getTime()\n        }));\n\n        const options = {\n          key: orderResponse.data.key_id,\n          amount: orderResponse.data.amount,\n          currency: orderResponse.data.currency,\n          name: 'Your OTT Platform',\n          description: `${selectedPlan.value.name} Subscription`,\n          order_id: orderResponse.data.order_id,\n          handler: handlePaymentSuccess,\n          prefill: {\n            name: user.value?.name || '',\n            email: user.value?.email || '',\n            contact: user.value?.phone || ''\n          },\n          theme: {\n            color: '#3399cc'\n          },\n          modal: {\n            ondismiss: function() {\n              // Start checking payment status when modal is closed\n              startPaymentStatusCheck(orderResponse.data.order_id);\n            }\n          },\n          config: {\n            display: {\n              blocks: {\n                upi: {\n                  preferred: true,\n                  name: \"UPI\",\n                  instruments: [\n                    { targetApp: \"phonepe\" },\n                    { targetApp: \"googlePay\" },\n                    { targetApp: \"paytm\" },\n                    { targetApp: \"upi\" }\n                  ]\n                }\n              }\n            }\n          }\n        };\n\n        const rzp = new window.Razorpay(options);\n        rzp.open();\n      } catch (error) {\n        console.error('Payment initiation failed:', error);\n        alert('Unable to initiate payment. Please try again.');\n      }\n    };\n\n    const startPaymentStatusCheck = async (orderId) => {\n      showStatusModal.value = true;\n      let attempts = 0;\n      const maxAttempts = 10; // 5 minutes (30 seconds * 10)\n\n      const checkStatus = async () => {\n        try {\n          const response = await axios.get(`/api/payment/check-status/${orderId}/`);\n          \n          if (response.data.status === 'completed') {\n            // Payment successful\n            showStatusModal.value = false;\n            clearInterval(statusCheckInterval.value);\n            localStorage.removeItem('pending_payment');\n            \n            // Show success message\n            alert('Payment successful! Your subscription is now active.');\n            router.push('/profile');\n            return;\n          }\n          \n          attempts++;\n          if (attempts >= maxAttempts) {\n            showStatusModal.value = false;\n            clearInterval(statusCheckInterval.value);\n            alert('Payment status could not be verified. Please contact support.');\n          }\n        } catch (error) {\n          console.error('Status check failed:', error);\n        }\n      };\n\n      // Check immediately\n      await checkStatus();\n      \n      // Then check every 30 seconds\n      statusCheckInterval.value = setInterval(checkStatus, 30000);\n    };\n\n    const handlePaymentSuccess = async (response) => {\n      try {\n        console.log('Payment successful, verifying:', response);\n        \n        const verifyResponse = await axios.post('/api/payment/verify-payment/', {\n          razorpay_payment_id: response.razorpay_payment_id,\n          razorpay_order_id: response.razorpay_order_id,\n          razorpay_signature: response.razorpay_signature,\n          phone: user.value?.phone,\n          plan_id: selectedPlan.value.id\n        });\n\n        if (verifyResponse.data.status === 'success') {\n          localStorage.removeItem('pending_payment');\n          alert('Payment successful! Your subscription is now active.');\n          router.push('/profile');\n        }\n      } catch (error) {\n        console.error('Payment verification failed:', error);\n        alert('Payment verification failed. Please contact support.');\n      }\n    };\n\n    // Cleanup on component unmount\n    onUnmounted(() => {\n      if (statusCheckInterval.value) {\n        clearInterval(statusCheckInterval.value);\n      }\n    });\n\n    return {\n      plans,\n      selectedPlan,\n      showPaymentForm,\n      showStatusModal,\n      selectPlan,\n      initiatePayment\n    };\n  }\n}\n</script>\n\n<style scoped>\n.payment-container {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 20px;\n}\n\n.subscription-plans {\n  text-align: center;\n}\n\n.plans {\n  display: flex;\n  justify-content: center;\n  gap: 20px;\n  margin-top: 30px;\n}\n\n.plan {\n  background: white;\n  border-radius: 10px;\n  padding: 20px;\n  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n  cursor: pointer;\n  transition: transform 0.2s;\n  width: 250px;\n}\n\n.plan:hover {\n  transform: translateY(-5px);\n}\n\n.price {\n  font-size: 24px;\n  font-weight: bold;\n  color: #3399cc;\n  margin: 10px 0;\n}\n\n.duration {\n  color: #666;\n  margin-bottom: 15px;\n}\n\n.select-btn {\n  background: #3399cc;\n  color: white;\n  border: none;\n  padding: 10px 20px;\n  border-radius: 5px;\n  margin-top: 10px;\n  cursor: pointer;\n  width: 100%;\n}\n\n.payment-summary {\n  max-width: 400px;\n  margin: 20px auto;\n  padding: 20px;\n  background: white;\n  border-radius: 10px;\n  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n}\n\n.pay-btn {\n  background: #3399cc;\n  color: white;\n  border: none;\n  padding: 12px 30px;\n  border-radius: 5px;\n  width: 100%;\n  margin-top: 20px;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.pay-btn:hover, .select-btn:hover {\n  background: #2980b9;\n}\n\n/* Status Modal Styles */\n.status-modal {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.5);\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  z-index: 1000;\n}\n\n.modal-content {\n  background: white;\n  padding: 30px;\n  border-radius: 10px;\n  text-align: center;\n}\n\n.loader {\n  border: 4px solid #f3f3f3;\n  border-top: 4px solid #3498db;\n  border-radius: 50%;\n  width: 40px;\n  height: 40px;\n  animation: spin 1s linear infinite;\n  margin: 20px auto;\n}\n\n@keyframes spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n</style>"],"mappings":";;EACOA,KAAK,EAAC;AAAmB;;;EACCA,KAAK,EAAC;;;EAE5BA,KAAK,EAAC;AAAO;;;EAGXA,KAAK,EAAC;AAAO;;EACbA,KAAK,EAAC;AAAU;;;EAMAA,KAAK,EAAC;;;;EAQHA,KAAK,EAAC;;;uBArBpCC,mBAAA,CA4BM,OA5BNC,UA4BM,G,CA3BQC,MAAA,CAAAC,eAAe,I,cAA3BH,mBAAA,CAUM,OAVNI,UAUM,G,0BATJC,mBAAA,CAAyB,YAArB,kBAAgB,QACpBA,mBAAA,CAOM,OAPNC,UAOM,I,kBANJN,mBAAA,CAKMO,SAAA,QAAAC,WAAA,CAL2BN,MAAA,CAAAO,KAAK,EAAbC,IAAI;yBAA7BV,mBAAA,CAKM;MALDD,KAAK,EAAC,MAAM;MAAwBY,GAAG,EAAED,IAAI,CAACE,EAAE;MAAGC,OAAK,EAAAC,MAAA,IAAEZ,MAAA,CAAAa,UAAU,CAACL,IAAI;QAC5EL,mBAAA,CAAwB,YAAAW,gBAAA,CAAjBN,IAAI,CAACO,IAAI,OAChBZ,mBAAA,CAAsC,KAAtCa,UAAsC,EAArB,GAAC,GAAAF,gBAAA,CAAGN,IAAI,CAACS,KAAK,OAC/Bd,mBAAA,CAAgD,KAAhDe,UAAgD,EAAAJ,gBAAA,CAAzBN,IAAI,CAACW,QAAQ,IAAG,OAAK,M,0BAC5ChB,mBAAA,CAA0C;MAAlCN,KAAK,EAAC;IAAY,GAAC,QAAM,O;kDAK5BG,MAAA,CAAAoB,YAAY,I,cAAvBtB,mBAAA,CAKM,OALNuB,UAKM,G,0BAJJlB,mBAAA,CAAwB,YAApB,iBAAe,QACnBA,mBAAA,CAAoC,WAAjC,QAAM,GAAAW,gBAAA,CAAGd,MAAA,CAAAoB,YAAY,CAACL,IAAI,OAC7BZ,mBAAA,CAAwC,WAArC,WAAS,GAAAW,gBAAA,CAAGd,MAAA,CAAAoB,YAAY,CAACH,KAAK,OACjCd,mBAAA,CAAiE;IAAxDQ,OAAK,EAAAW,MAAA,QAAAA,MAAA,UAAAC,IAAA,KAAEvB,MAAA,CAAAwB,eAAA,IAAAxB,MAAA,CAAAwB,eAAA,IAAAD,IAAA,CAAe;IAAE1B,KAAK,EAAC;KAAU,SAAO,E,oCAI/CG,MAAA,CAAAyB,eAAe,I,cAA1B3B,mBAAA,CAMM,OANN4B,UAMM,EAAAJ,MAAA,QAAAA,MAAA,OALJnB,mBAAA,CAIM;IAJDN,KAAK,EAAC;EAAe,IACxBM,mBAAA,CAAmC,YAA/B,4BAA0B,GAC9BA,mBAAA,CAAgD,WAA7C,2CAAyC,GAC5CA,mBAAA,CAA0B;IAArBN,KAAK,EAAC;EAAQ,G","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}